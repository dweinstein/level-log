var extend = require('lodash').extend;
var timehat = require('timehat');
var parse = JSON.parse;
var extra = require('db/extra-fields');
var moment = require('moment');

var _ = require('lodash');
var noop = require('lodash').noop;

module.exports = function handle(server, models, rinfo, msg, next) {
  next = next || noop;
  msg = parse(msg);

  event = new models.LogEvent(msg);
  var extras = extra(_.keys(models.LogEvent.attrs), msg);
  event.id(timehat());
  event.extras(_.pick(msg, extras));
  event.timestamp(moment().format());
  event.save(function (err) {
    if (err) throw err;
    console.log(event.toJSON());
    next(null, event.id());
  });
};

